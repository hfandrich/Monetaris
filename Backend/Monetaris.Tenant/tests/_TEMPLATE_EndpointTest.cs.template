using Xunit;
using Moq;
using FluentAssertions;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using Monetaris.{DOMAIN}.Api;
using Monetaris.{DOMAIN}.Services;
using Monetaris.{DOMAIN}.Models;
using Monetaris.Shared.Models;
using Monetaris.Shared.Models.Entities;
using Monetaris.Shared.Interfaces;
using Monetaris.Shared.Enums;
using System.Security.Claims;
using Microsoft.AspNetCore.Http;

namespace Monetaris.{DOMAIN}.Tests;

/// <summary>
/// Unit tests for {ENDPOINT_NAME} endpoint
/// Template file for creating new endpoint tests
///
/// Usage:
/// 1. Copy this file and rename it to {ENDPOINT_NAME}.Tests.cs
/// 2. Replace all {DOMAIN} placeholders with your domain name (e.g., Kreditor, Debtor)
/// 3. Replace all {ENDPOINT_NAME} placeholders with your endpoint name (e.g., GetAllKreditoren)
/// 4. Replace {METHOD} with the service method name (e.g., GetAllAsync)
/// 5. Replace {RESPONSE_TYPE} with the expected response type (e.g., List<KreditorDto>)
/// 6. Implement test scenarios specific to your endpoint
/// 7. Add additional test methods as needed
/// </summary>
public class {ENDPOINT_NAME}Tests
{
    private readonly Mock<I{DOMAIN}Service> _mockService;
    private readonly Mock<IApplicationDbContext> _mockContext;
    private readonly Mock<ILogger<{ENDPOINT_NAME}>> _mockLogger;
    private readonly {ENDPOINT_NAME} _endpoint;

    public {ENDPOINT_NAME}Tests()
    {
        _mockService = new Mock<I{DOMAIN}Service>();
        _mockContext = new Mock<IApplicationDbContext>();
        _mockLogger = new Mock<ILogger<{ENDPOINT_NAME}>>();

        _endpoint = new {ENDPOINT_NAME}(_mockService.Object, _mockContext.Object, _mockLogger.Object);
    }

    [Fact]
    public async Task Handle_ReturnsOkResult_WhenSuccessful()
    {
        // Arrange
        var userId = Guid.NewGuid();
        var user = new User
        {
            Id = userId,
            Email = "admin@test.com",
            Role = UserRole.ADMIN
        };

        // TODO: Create your expected test data
        var expectedData = new {RESPONSE_TYPE}(); // Replace with actual data initialization
        var result = Result<{RESPONSE_TYPE}>.Success(expectedData);

        SetupHttpContext(userId);
        SetupUserDbSet(user);
        _mockService.Setup(s => s.{METHOD}Async(/* Add expected parameters */))
            .ReturnsAsync(result);

        // Act
        var actionResult = await _endpoint.Handle(/* Add required parameters */);

        // Assert
        actionResult.Should().BeOfType<OkObjectResult>();
        var okResult = actionResult as OkObjectResult;
        okResult!.Value.Should().BeEquivalentTo(expectedData);

        _mockService.Verify(s => s.{METHOD}Async(/* Add expected parameters */), Times.Once);
    }

    [Fact]
    public async Task Handle_ReturnsBadRequest_WhenServiceFails()
    {
        // Arrange
        var userId = Guid.NewGuid();
        var user = new User
        {
            Id = userId,
            Email = "admin@test.com",
            Role = UserRole.ADMIN
        };

        var result = Result<{RESPONSE_TYPE}>.Failure("Service error");

        SetupHttpContext(userId);
        SetupUserDbSet(user);
        _mockService.Setup(s => s.{METHOD}Async(/* Add expected parameters */))
            .ReturnsAsync(result);

        // Act
        var actionResult = await _endpoint.Handle(/* Add required parameters */);

        // Assert
        actionResult.Should().BeOfType<BadRequestObjectResult>();
    }

    [Fact]
    public async Task Handle_ReturnsUnauthorized_WhenUserNotFound()
    {
        // Arrange
        var userId = Guid.NewGuid();

        SetupHttpContext(userId);
        SetupUserDbSet(null);

        // Act
        var actionResult = await _endpoint.Handle(/* Add required parameters */);

        // Assert
        actionResult.Should().BeOfType<UnauthorizedResult>();
        _mockService.Verify(s => s.{METHOD}Async(It.IsAny<{RESPONSE_TYPE}>()), Times.Never);
    }

    // TODO: Add more test methods based on your endpoint's specific behavior:
    // - Test different user roles (ADMIN, AGENT, CLIENT)
    // - Test authorization scenarios
    // - Test validation failures
    // - Test edge cases
    // - Test specific business logic

    #region Helper Methods

    private void SetupHttpContext(Guid userId)
    {
        var claims = new List<Claim> { new Claim(ClaimTypes.NameIdentifier, userId.ToString()) };
        var identity = new ClaimsIdentity(claims, "Test");
        var claimsPrincipal = new ClaimsPrincipal(identity);

        var httpContext = new DefaultHttpContext { User = claimsPrincipal };
        _endpoint.ControllerContext = new ControllerContext { HttpContext = httpContext };
    }

    private void SetupUserDbSet(User? user)
    {
        _mockContext.Setup(c => c.Users.FindAsync(It.IsAny<Guid>()))
            .ReturnsAsync(user);
    }

    #endregion
}
