name: E2E Tests

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  playwright:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: monetaris
          POSTGRES_USER: monetaris_user
          POSTGRES_PASSWORD: monetaris_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Start Backend API
      run: |
        cd Backend/MonetarisApi
        dotnet restore
        dotnet build
        nohup dotnet run --no-build &
        sleep 30  # Wait for API to start
      env:
        ASPNETCORE_URLS: http://localhost:5000
        ConnectionStrings__DefaultConnection: "Host=localhost;Database=monetaris;Username=monetaris_user;Password=monetaris_pass"

    - name: Install Frontend Dependencies
      run: |
        cd Frontend
        npm ci

    - name: Install Playwright Browsers
      run: |
        cd Frontend
        npx playwright install --with-deps

    - name: Run Playwright E2E Tests
      run: |
        cd Frontend
        npm run test:e2e
      env:
        VITE_API_URL: http://localhost:5000/api

    - name: Upload Playwright Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: Frontend/playwright-report/

    - name: Upload Test Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-screenshots
        path: Frontend/test-results/
